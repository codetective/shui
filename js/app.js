let loader=document.querySelector(".loader");const tsbx=document.querySelector(".toastbox"),spinner=document.querySelector("#spinner-wrapper"),url="https://shoprecord.herokuapp.com",showToast=(e,t)=>{const a=document.createElement("div");a.classList.add("toastbx"),a.textContent=e,a.style.backgroundColor=t,tsbx.appendChild(a),requestAnimationFrame(()=>a.classList.add("sh-toastbx")),setTimeout(function(){requestAnimationFrame(()=>a.classList.remove("sh-toastbx")),setTimeout(function(){requestAnimationFrame(()=>tsbx.removeChild(a))},500)},3300)};let loginForm=document.querySelector("#login-form"),indicator=document.querySelector("#admin"),loginSection=document.querySelector("#login"),main=document.querySelector("main"),status=JSON.parse(localStorage.getItem("shopperutilscode"))||null;window.addEventListener("DOMContentLoaded",()=>{main.hidden=!0,null!=status?(main.hidden=!1,loginSection.hidden=!0,indicator.innerText=`(${status.name})`,app()):(main.hidden=!0,loader.style.display="none")}),loginForm.addEventListener("submit",e=>{e.preventDefault();const t=new FormData(loginForm),a=t.get("name"),o=t.get("password");let n=JSON.stringify({name:a,password:o});login(n)});const login=async e=>{loader.style.display="";try{const t=await fetch(url+"/login",{method:"POST",headers:{"Content-Type":"application/json"},body:e}),a=await t.json();if(loader.style.display="none",a.error)return void showToast(a.error,"red");localStorage.setItem("shopperutilscode",JSON.stringify({name:a.profile.name,role:a.profile.role,token:a.token})),main.hidden=!1,loginSection.hidden=!0,loginSection.remove(),app(),indicator.innerText=`(${a.profile.name})`,status=localStorage.getItem("shopperutilscode")}catch(e){loader.style.display="none",showToast(e+", please retry","red")}};let app=()=>{let e=JSON.parse(localStorage.getItem("shopperutilscode"));if("admin"!==e.role){document.querySelector("#accordion-wrapper").remove()}async function t(){try{const e=fetch(new Request(url,{method:"GET",cache:"reload"})),t=await e;if(t.ok){const e=await t.json();loader.style.display="none",spinner.style.display="none",showToast("stocks updated","green"),a(e.stocks)}else showToast("error encountered. Please retry","red")}catch(e){loader.style.display="none",spinner.style.display="none",showToast(e,"red")}}t();const a=e=>{d.innerHTML="",e.forEach(t=>{const a=document.createElement("div");a.dataset.stock=t.name,a.className="stock",a.innerHTML=`<div data-stockname="${t.name}">${t.name}</div>\n          <div>\n            <span data-qty="${t.qty}">${t.qty}</span>\n            <button data-stockname ="${t.name}" ><img src="./css/trash-fill.svg"></button>\n          </div>`,d.appendChild(a),f(e)})},o=document.querySelector(".cart"),n=document.querySelector("#cart-items"),s=document.getElementById("cart-toggle"),r=document.querySelector(".cart-overlay");s.onclick=(()=>{r.classList.toggle("show-overlay"),o.classList.toggle("show-cart")}),r.onclick=(()=>{o.classList.remove("show-cart"),r.classList.remove("show-overlay")});const i=document.querySelectorAll(".accordion-item__label"),c=document.querySelectorAll(".accordion-tab");function l(){const e=this.classList.contains("accordion-tab")?this:this.parentElement,t=e.dataset.actabGroup,a=e.dataset.actabId;c.forEach(function(e){e.dataset.actabGroup===t&&(e.dataset.actabId===a?e.classList.add("accordion-active"):e.classList.remove("accordion-active"))}),i.forEach(function(e){const o=e.parentElement;o.dataset.actabGroup===t&&(o.dataset.actabId===a?o.classList.add("accordion-active"):o.classList.remove("accordion-active"))})}i.forEach(function(e){e.addEventListener("click",l)}),c.forEach(function(e){e.addEventListener("click",l)});const d=document.querySelector("#stockbox");let m=document.querySelector("#cart-sum"),p=document.getElementsByClassName("cart-item"),u=document.querySelector("#cart-submit"),y=document.querySelector("#addStockForm"),h=document.querySelector("#stockUpdateForm"),g=document.querySelector("#stockUpdateName");n.addEventListener("click",e=>{if(e.target.classList.contains("cart-item")){e.target.parentNode.removeChild(e.target);let t=S.indexOf(e.target.textContent);S.splice(t,1),v()}}),u.addEventListener("click",()=>{u.classList.add("disabled");const e=[];for(let t=0;t<p.length;t++){const a=p[t];let o={name:a.dataset.cartname,qty:parseInt(a.children[1].value)};if(o.qty<1)return alert("Values cannot be 0"),void setTimeout(()=>{u.classList.remove("disabled")},1500);spinner.style.display="block",e.push(o)}(async e=>{spinner.style.display="flex";try{const a=await fetch(url+"/sale",{method:"POST",headers:{"Content-Type":"application/json"},body:e});await a.json(),n.innerHTML="",v(),u.classList.remove("disabled"),S=[""],t()}catch(e){showToast(e),u.classList.remove("disabled"),spinner.style.display="none"}})(JSON.stringify(e))});const f=t=>{"admin"===e.role&&(g.innerHTML="",t.forEach(e=>{let t=document.createElement("option");t.innerText=e.name,g.appendChild(t)}))},v=()=>{m.innerText=p.length};v();let S=[];d.addEventListener("click",a=>{if(a.target.dataset.hasOwnProperty("stock")&&!S.includes(a.target.dataset.stock)){S.push(a.target.dataset.stock);let e=document.createElement("li");e.className="cart-item",e.dataset.cartname=a.target.dataset.stock,e.innerHTML=`<span class="mr-3">${a.target.dataset.stock}</span>\n            <input type="number" id="cart-item-qty" min="1" value="1">`,n.appendChild(e),v()}else"BUTTON"===a.target.tagName&&(async a=>{if("admin"===e.role){spinner.style.display="flex",S=[""],n.innerHTML="",v(),u.classList.remove("disabled");try{const o=await fetch(url,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.token},body:a}),n=await o.json();n.error?(showToast(n.error,"red"),spinner.style.display="none"):t()}catch(e){showToast(e),spinner.style.display="none"}}})(JSON.stringify({name:a.target.dataset.stockname}))}),"admin"===e.role&&(y.addEventListener("submit",a=>{a.preventDefault();const o=new FormData(y),n=o.get("name"),s=o.get("qty");(async a=>{if("admin"===e.role){spinner.style.display="flex";try{const o=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.token},body:a});y.reset();const n=await o.json();n.msg?(spinner.style.display="none",showToast(n.msg,"red")):t()}catch(e){spinner.style.display="none",showToast(e,"red")}}})(JSON.stringify({name:n,qty:s}))}),h.addEventListener("submit",a=>{a.preventDefault();const o=new FormData(h),n=o.get("name"),s=o.get("qty");(async a=>{if("admin"===e.role){spinner.style.display="flex";try{const o=await fetch(url,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.token},body:a});h.reset();const n=await o.json();n.error?(showToast(n.error,"red"),spinner.style.display="none"):t()}catch(e){spinner.style.display="none",showToast(e,"red")}}})(JSON.stringify({name:n,qty:s}))}))},logout=document.querySelector("#logout");logout.onclick=(()=>{localStorage.removeItem("shopperutilscode"),location.reload()});